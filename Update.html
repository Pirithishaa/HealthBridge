<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HealthBridge SDOH Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: transparent; min-height: 100vh; }
    
    .chatbot-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
    
    .chatbot-toggle { 
      width: 70px; height: 70px; background: linear-gradient(135deg, #1a3a32, #1a3a32); 
      border-radius: 50%; border: none; cursor: pointer; 
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); 
      display: flex; align-items: center; justify-content: center; 
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
      position: relative; overflow: hidden; 
    }
    .chatbot-toggle:hover { 
      transform: scale(1.1); 
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); 
    }

    .bot-icon {
      font-size: 32px;
      color: white;
      transition: transform 0.3s ease;
    }

    .chatbot-toggle.active .bot-icon { transform: rotate(180deg); }

    .chat-window { 
      position: absolute; bottom: 80px; right: 0; width: 400px; height: 600px; 
      background: white; border-radius: 20px; 
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15); 
      transform: scale(0) translateY(20px); opacity: 0; 
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
      overflow: hidden; display: flex; flex-direction: column; 
    }
    .chat-window.open { transform: scale(1) translateY(0); opacity: 1; }

    .chat-header { 
      background: linear-gradient(135deg, #1a3a32, #1a3a32); 
      color: white; padding: 20px; border-radius: 20px 20px 0 0; 
      text-align: center; position: relative; 
    }
    .chat-header h3 { 
      font-size: 1.3rem; font-weight: 700; margin: 0; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .chat-header .status { 
      font-size: 0.9rem; opacity: 0.9; margin-top: 5px; 
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .status-indicator {
      width: 8px; height: 8px; background: #4ade80; border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .close-btn { 
      position: absolute; top: 15px; right: 15px; background: none; border: none; 
      color: white; font-size: 1.5rem; cursor: pointer; width: 35px; height: 35px; 
      border-radius: 50%; display: flex; align-items: center; justify-content: center; 
      transition: all 0.3s ease; 
    }
    .close-btn:hover { background-color: rgba(255, 255, 255, 0.2); transform: rotate(90deg); }

    .chat-messages { 
      flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; 
      gap: 15px; background: linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%);
    }
    
    .message { 
      max-width: 85%; padding: 14px 18px; border-radius: 20px; 
      font-size: 0.95rem; line-height: 1.5; animation: slideIn 0.3s ease; 
      position: relative; word-wrap: break-word;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.bot { 
      background: white; color: #333; align-self: flex-start; 
      border-bottom-left-radius: 6px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 3px solid #1a3a32;
    }
    
    .message.user { 
      background: linear-gradient(135deg, #1a3a32, #1a3a32); 
      color: white; align-self: flex-end; border-bottom-right-radius: 6px; 
      white-space: pre-wrap; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .message.bot::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 15px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid white;
    }

    .message.user::before {
      content: '';
      position: absolute;
      right: -8px;
      top: 15px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid #1a3a32;
    }

    .chat-input-container { 
      padding: 20px; border-top: 1px solid #e1e5e9; 
      background: white; border-radius: 0 0 20px 20px;
    }
    
    .chat-input-wrapper { 
      display: flex; gap: 12px; align-items: center; 
      background: #f8f9fa; border-radius: 25px; padding: 4px;
      border: 2px solid transparent; transition: all 0.3s ease;
    }
    .chat-input-wrapper:focus-within { 
      border-color: #1a3a32; background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .chat-input { 
      flex: 1; padding: 12px 16px; border: none; border-radius: 20px; 
      font-size: 0.95rem; outline: none; background: transparent;
      font-family: inherit;
    }
    .chat-input::placeholder { color: #9ca3af; }

    .send-btn { 
      width: 45px; height: 45px; background: linear-gradient(135deg, #1a3a32,#1a3a32); 
      border: none; border-radius: 50%; cursor: pointer; 
      display: flex; align-items: center; justify-content: center; 
      transition: all 0.3s ease; margin-right: 2px;
    }
    .send-btn:hover:not(:disabled) { 
      transform: scale(1.05); 
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); 
    }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .send-icon { width: 20px; height: 20px; fill: white; }

    .typing-indicator { 
      display: flex; align-items: center; gap: 8px; padding: 14px 18px; 
      background: white; border-radius: 20px; border-bottom-left-radius: 6px; 
      align-self: flex-start; max-width: 100px; position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 3px solid #1a3a32;
    }
    .typing-indicator::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 15px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid white;
    }
    .typing-dot { 
      width: 8px; height: 8px; background: #1a3a32; border-radius: 50%; 
      animation: typingAnimation 1.4s infinite ease-in-out; 
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingAnimation { 
      0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 
      30% { transform: translateY(-10px); opacity: 1; } 
    }

 
    .quick-actions {
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
    }
    .quick-action {
      background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 15px;
      padding: 8px 12px; font-size: 0.8rem; cursor: pointer;
      transition: all 0.2s ease; color: #667eea;
    }
    .quick-action:hover {
      background: #1a3a32; color: white; transform: translateY(-1px);
    }

    .message-time {
      font-size: 0.7rem; opacity: 0.6; margin-top: 5px; text-align: right;
    }
    .message.bot .message-time { text-align: left; }

    /* Message formatting */
    .message b { font-weight: 600; }
    .message ul { margin: 8px 0; padding-left: 20px; }
    .message li { margin: 4px 0; }
    .message h4 { font-weight: 600; margin: 10px 0 5px 0; color: #667eea; }

    @media (max-width: 480px) { 
      .chat-window { width: calc(100vw - 40px); right: -10px; height: 500px; } 
      .chatbot-container { right: 20px; bottom: 20px; } 
    }

    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { 
      background: linear-gradient(135deg, #1a3a32, #1a3a32); 
      border-radius: 3px; 
    }
  </style>
</head>
<body>
  <div class="chatbot-container">
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <button class="close-btn" id="closeBtn">&times;</button>
        <h3>HealthBridge SDOH Assistant</h3>
        <div class="status">
          <span class="status-indicator"></span>
          AI Assistant - Online
        </div>
      </div>
      

      
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will appear here -->
      </div>
      
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask about SDOH, volunteer programs, or portal help..." maxlength="500">
          <button class="send-btn" id="sendBtn">
            <svg class="send-icon" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <button class="chatbot-toggle" id="chatToggle">
      <i class="fas fa-robot bot-icon" aria-hidden="true"></i>
    </button>
  </div>

<script>
  class HealthBridgeSDOHAssistant {
    constructor() {
      this.isOpen = false;
      this.isTyping = false;
      this.messageCount = 0;
      this.initializeElements();
      this.attachEventListeners();
      this.addInitialMessage();
    }

    initializeElements() {
      this.chatToggle = document.getElementById('chatToggle');
      this.chatWindow = document.getElementById('chatWindow');
      this.closeBtn = document.getElementById('closeBtn');
      this.chatInput = document.getElementById('chatInput');
      this.sendBtn = document.getElementById('sendBtn');
      this.chatMessages = document.getElementById('chatMessages');
      
    }

    attachEventListeners() {
      this.chatToggle.addEventListener('click', () => this.toggleChat());
      this.closeBtn.addEventListener('click', () => this.closeChat());
      this.sendBtn.addEventListener('click', () => this.sendMessage());
      this.chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.chatInput.addEventListener('input', () => this.updateSendButton());
      
      // Quick action buttons
      document.querySelectorAll('.quick-action').forEach(btn => {
        btn.addEventListener('click', () => {
          const message = btn.getAttribute('data-message');
          this.chatInput.value = message;
          this.sendMessage();
        });
      });
    }

    addInitialMessage() {
      const welcomeText = "Hello! How can I assist you today regarding social determinants of health, volunteer programs, policy guidelines, or the HealthBridge patient portal?";
      this.addMessage(welcomeText, 'bot', true);
    }

    toggleChat() { this.isOpen ? this.closeChat() : this.openChat(); }
    
    openChat() { 
      this.isOpen = true; 
      this.chatWindow.classList.add('open'); 
      this.chatToggle.classList.add('active'); 
      setTimeout(() => this.chatInput.focus(), 300);
    }
    
    closeChat() { 
      this.isOpen = false; 
      this.chatWindow.classList.remove('open'); 
      this.chatToggle.classList.remove('active'); 
    }
    
    updateSendButton() { 
      const hasText = this.chatInput.value.trim().length > 0; 
      this.sendBtn.disabled = !hasText || this.isTyping; 
    }

    async sendMessage() {
      const message = this.chatInput.value.trim();
      if (!message || this.isTyping) return;

     

      this.addMessage(message, 'user');
      this.chatInput.value = '';
      this.updateSendButton();
      this.showTypingIndicator();
      this.messageCount++;

      try {
        const response = await this.generateResponse(message);
        this.hideTypingIndicator();
        this.addMessage(response, 'bot', true);
      } catch (error) {
        this.hideTypingIndicator();
        this.addMessage("I apologize, but I'm having trouble connecting right now. Please try again in a moment! 😊", 'bot', true);
      }
    }

    addMessage(text, sender, isHTML = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      if (isHTML) {
        let formatted = text
          .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
          .replace(/^- (.*?)$/gm, "<li>$1</li>")
          .replace(/^# (.*?)$/gm, "<h4>$1</h4>")
          .replace(/\n\n/g, "<br><br>")
          .replace(/\n/g, "<br>");
        
        if (formatted.includes("<li>")) {
          formatted = formatted.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
        }
        
        messageDiv.innerHTML = formatted;
      } else {
        messageDiv.textContent = text;
      }

      // Add timestamp
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      messageDiv.appendChild(timeDiv);

      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    showTypingIndicator() {
      this.isTyping = true;
      this.updateSendButton();
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typingIndicator';
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        typingDiv.appendChild(dot);
      }
      this.chatMessages.appendChild(typingDiv);
      this.scrollToBottom();
    }

    hideTypingIndicator() { 
      const typingIndicator = document.getElementById('typingIndicator'); 
      if (typingIndicator) typingIndicator.remove(); 
      this.isTyping = false; 
      this.updateSendButton(); 
    }
    
    scrollToBottom() { 
      setTimeout(() => {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }, 100);
    }

    async generateResponse(userMessage) {
      try {
        const response = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyAlDTZO7v-Tc41FcnyhP1mUY0uBtHO4x88",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [{ 
                    text: userMessage
                  }]
                }
              ],
              systemInstruction: {
                parts: [{
                  text: "You are an AI-powered SDOH (Social Determinants of Health) assistant for HealthBridge. Your purpose is to assist healthcare providers and NGO staff with questions about SDOH, volunteer programs, and policy guidelines. You also help users navigate the HealthBridge patient portal. You are NOT for direct patient advice or diagnosis. Always focus on programs, community engagement, social factors, and policies. If a question is outside this scope, politely decline to answer. Structure your responses clearly with headings."
                }]
              },
              generationConfig: {
                temperature: 0.7,
                topP: 0.8,
                topK: 40,
                maxOutputTokens: 1000,
              }
            })
          }
        );

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        if (!data.candidates || data.candidates.length === 0) {
          return "I apologize, but I couldn't generate a proper response. Could you please rephrase your question?";
        }

        const reply = data.candidates[0]?.content?.parts?.[0]?.text;
        
        if (!reply) {
          return "I'm having trouble understanding that. Could you please try asking in a different way?";
        }

        return reply;
        
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const chatbot = new HealthBridgeSDOHAssistant();
    
    // Auto-open after 8 seconds if not opened manually
    setTimeout(() => { 
      if (!chatbot.isOpen) {
        chatbot.openChat(); 
      }
    }, 8000);
  });

  // Interactive hover effect for toggle button
  document.addEventListener('mousemove', (e) => {
    const chatToggle = document.getElementById('chatToggle');
    if (!chatToggle) return;
    
    const rect = chatToggle.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const deltaX = e.clientX - centerX;
    const deltaY = e.clientY - centerY;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    if (distance < 120) {
      const intensity = Math.max(0, 1 - distance / 120);
      const scale = 1 + intensity * 0.15;
      chatToggle.style.transform = `scale(${scale})`;
    } else {
      chatToggle.style.transform = 'scale(1)';
    }
  });
</script>
</body>
</html>